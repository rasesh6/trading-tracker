<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Tracker Dashboard - Spreads</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; font-weight: 600; }
        .header-buttons { display: flex; gap: 10px; }
        .update-btn, .reset-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .reset-btn { background: #ef4444; }
        .update-btn:hover { background: #2563eb; }
        .reset-btn:hover { background: #dc2626; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; }
        .stat-card h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; }
        .stat-card .value.positive { color: #22c55e; }
        .stat-card .value.negative { color: #ef4444; }
        .stat-card .sub { font-size: 13px; color: #64748b; margin-top: 4px; }

        .section { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .section h2 { font-size: 18px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .section h2 .count { font-size: 14px; color: #64748b; font-weight: normal; }

        .spread-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .spread-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .spread-title { font-size: 16px; font-weight: 600; }
        .spread-type { font-size: 12px; color: #94a3b8; margin-top: 4px; }
        .spread-pl { font-size: 24px; font-weight: 700; }
        .spread-pl.positive { color: #22c55e; }
        .spread-pl.negative { color: #ef4444; }
        .spread-meta { display: flex; gap: 20px; font-size: 13px; color: #64748b; }
        .spread-legs { margin-top: 12px; padding-top: 12px; border-top: 1px solid #334155; }
        .spread-leg { display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; }
        .leg-symbol { font-family: monospace; }
        .leg-side { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .leg-side.BUY { background: #22c55e20; color: #22c55e; }
        .leg-side.SELL { background: #ef444420; color: #ef4444; }

        .chart-section { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .chart-section h2 { font-size: 18px; margin-bottom: 15px; }

        .last-updated { text-align: center; color: #64748b; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Options Spread Tracker</h1>
            <div class="header-buttons">
                <button class="reset-btn" onclick="resetData()">Reset DB</button>
                <button class="update-btn" onclick="updateData()">Update Data</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Realized P&L</h3>
                <div class="value" id="total-pl">$0.00</div>
                <div class="sub" id="total-closed">0 closed spreads</div>
            </div>
            <div class="stat-card">
                <h3>Total Unrealized P&L</h3>
                <div class="value" id="total-unrealized-pl">$0.00</div>
                <div class="sub" id="open-count-label">0 open spreads</div>
            </div>
            <div class="stat-card">
                <h3>Total Spreads</h3>
                <div class="value" id="total-spreads">0</div>
                <div class="sub" id="closed-spreads">0 closed</div>
            </div>
            <div class="stat-card">
                <h3>Average P&L</h3>
                <div class="value" id="avg-pl">$0.00</div>
                <div class="sub">Per closed spread</div>
            </div>
        </div>

        <div class="chart-section">
            <h2>Cumulative P&L (All Spreads)</h2>
            <canvas id="pnlChart" height="100"></canvas>
        </div>

        <div class="section">
            <h2>Open Spreads <span class="count" id="open-spreads-count">0</span></h2>
            <div id="open-spreads"></div>
        </div>

        <div class="section">
            <h2>Single Legs <span class="count" id="single-legs-count">0</span></h2>
            <div id="single-legs"></div>
        </div>

        <div class="section">
            <h2>Closed Spreads <span class="count" id="closed-count-label">0</span></h2>
            <div id="closed-spreads"></div>
        </div>

        <p class="last-updated">Last updated: <span id="last-updated">Never</span></p>
    </div>

    <script>
        let pnlChart = null;

        async function loadData() {
            const response = await fetch('/api/stats');
            const data = await response.json();

            // Update stats
            const pl = (val) => {
                const v = val || 0;
                return v >= 0 ? `+$${v.toFixed(2)}` : `-$${Math.abs(v).toFixed(2)}`;
            };
            const setPl = (id, val) => {
                const el = document.getElementById(id);
                el.textContent = pl(val);
                el.className = 'value ' + (val >= 0 ? 'positive' : 'negative');
            };

            setPl('total-pl', data.total_realized_pl);
            setPl('total-unrealized-pl', data.total_unrealized_pl);
            document.getElementById('total-closed').textContent = `${data.closed_spreads} closed spreads`;
            document.getElementById('total-spreads').textContent = data.total_spreads;
            document.getElementById('closed-spreads').textContent = `${data.closed_spreads} closed`;
            document.getElementById('open-spreads-count').textContent = data.open_spreads;
            document.getElementById('single-legs-count').textContent = data.open_single_legs || 0;

            const avgPl = (data.closed_spreads + (data.closed_single_legs || 0)) > 0 ? data.total_realized_pl / (data.closed_spreads + data.closed_single_legs) : 0;
            setPl('avg-pl', avgPl);

            document.getElementById('open-count-label').textContent = `${data.open_spreads} open spreads`;
            document.getElementById('closed-count-label').textContent = `(${data.closed_spreads})`;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();

            // Render spreads
            renderSpreads(data.spreads);

            // Render single legs
            renderSingleLegs(data.single_legs || []);

            // Load chart data
            loadChartData();
        }

        function renderSpreads(spreads) {
            const openContainer = document.getElementById('open-spreads');
            const closedContainer = document.getElementById('closed-spreads');

            const openSpreads = spreads.filter(s => s.status === 'open');
            const closedSpreads = spreads.filter(s => s.status === 'closed');

            openContainer.innerHTML = openSpreads.length ? openSpreads.map(s => renderSpreadCard(s)).join('') : '<p style="color:#64748b;">No open spreads</p>';
            closedContainer.innerHTML = closedSpreads.length ? closedSpreads.map(s => renderSpreadCard(s)).join('') : '<p style="color:#64748b;">No closed spreads</p>';
        }

        function renderSingleLegs(singleLegs) {
            const container = document.getElementById('single-legs');
            const openLegs = singleLegs.filter(l => l.status === 'open');
            const closedLegs = singleLegs.filter(l => l.status === 'closed');

            let html = '';
            if (openLegs.length) {
                html += '<h3 style="color:#94a3b8;margin:15px 0 10px;">Open Single Legs</h3>';
                html += openLegs.map(l => renderSingleLegCard(l)).join('');
            }
            if (closedLegs.length) {
                html += '<h3 style="color:#94a3b8;margin:15px 0 10px;">Closed Single Legs</h3>';
                html += closedLegs.slice(0, 10).map(l => renderSingleLegCard(l)).join(''); // Show first 10
            }

            container.innerHTML = html || '<p style="color:#64748b;">No single legs</p>';
        }

        function renderSingleLegCard(leg) {
            const optType = leg.opt_type === 'C' ? 'CALL' : 'PUT';
            const legType = `${leg.side} ${optType}`;
            const isClosed = leg.status === 'closed';
            const pl = isClosed ? (leg.realized_pl || 0) : (leg.unrealized_pl || 0);
            const plClass = pl >= 0 ? 'positive' : 'negative';

            const openedDate = new Date(leg.opened_date).toLocaleDateString();
            const entryTotal = leg.entry_price * leg.quantity;

            return `
                <div class="spread-card">
                    <div class="spread-header">
                        <div>
                            <div class="spread-title">${leg.underlying} - ${leg.expiry} @ $${leg.strike}</div>
                            <div class="spread-type">${legType} Ã— ${leg.quantity}</div>
                        </div>
                        <div class="spread-pl ${plClass}">
                            ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)}
                        </div>
                    </div>
                    <div class="spread-meta">
                        <span>Opened: ${openedDate}</span>
                        <span style="color:${isClosed ? '#10b981' : '#f59e0b'};">${isClosed ? 'CLOSED' : 'OPEN'}</span>
                        <span>Entry: $${entryTotal >= 0 ? '+' : ''}${entryTotal.toFixed(2)}</span>
                        <span>@ $${leg.entry_price.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function renderSpreadCard(spread) {
            const legs = JSON.parse(spread.legs || '[]');
            const isClosed = spread.status === 'closed';
            const displayPl = isClosed ? spread.realized_pl : (spread.unrealized_pl || 0);
            const plClass = displayPl >= 0 ? 'positive' : 'negative';

            const openedDate = new Date(spread.opened_date).toLocaleDateString();
            const closedDate = isClosed && spread.closed_date ? new Date(spread.closed_date).toLocaleDateString() : null;

            return `
                <div class="spread-card">
                    <div class="spread-header">
                        <div>
                            <div class="spread-title">${spread.underlying} - ${spread.expiry}</div>
                            <div class="spread-type">${spread.spread_type}</div>
                        </div>
                        <div class="spread-pl ${plClass}">
                            ${displayPl >= 0 ? '+' : ''}$${(displayPl || 0).toFixed(2)}
                        </div>
                    </div>
                    <div class="spread-meta">
                        <span>Opened: ${openedDate}</span>
                        ${closedDate ? `<span>Closed: ${closedDate}</span>` : '<span style="color:#f59e0b;">OPEN</span>'}
                        <span>Entry: ${spread.entry_credit >= 0 ? '+' : ''}$${spread.entry_credit.toFixed(2)}</span>
                        ${isClosed ? `<span>Exit: $${(spread.exit_debit || 0).toFixed(2)}</span>` : ''}
                    </div>
                </div>
            `;
        }

        async function loadChartData() {
            const response = await fetch('/api/trades?days=365');
            const spreads = await response.json();

            // Group by date for cumulative P&L
            const dailyPl = {};
            for (const spread of spreads) {
                if (spread.status === 'closed' && spread.realized_pl !== 0) {
                    const date = new Date(spread.closed_date || spread.opened_date).toLocaleDateString();
                    dailyPl[date] = (dailyPl[date] || 0) + spread.realized_pl;
                }
            }

            // Sort dates
            const sortedDates = Object.keys(dailyPl).sort((a, b) => new Date(a) - new Date(b));
            const data = sortedDates.map(d => dailyPl[d]);

            // Calculate cumulative
            let cumulative = 0;
            const cumulativeData = data.map(v => { cumulative += v; return cumulative; });

            updateChart(sortedDates, cumulativeData);
        }

        function updateChart(labels, data) {
            const ctx = document.getElementById('pnlChart').getContext('2d');

            if (pnlChart) pnlChart.destroy();

            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: data,
                        borderColor: data[data.length-1] >= 0 ? '#22c55e' : '#ef4444',
                        backgroundColor: data[data.length-1] >= 0 ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', maxTicksLimit: 10 } },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        async function updateData() {
            const btn = document.querySelector('.update-btn');
            btn.textContent = 'Updating...';
            await fetch('/api/update');
            await loadData();
            btn.textContent = 'Update Data';
        }

        async function resetData() {
            if (!confirm('This will delete all data and recalculate from Public API. Continue?')) return;
            const btn = document.querySelector('.reset-btn');
            btn.textContent = 'Resetting...';
            await fetch('/api/reset');
            await loadData();
            btn.textContent = 'Reset DB';
        }

        // Auto-refresh every 5 minutes
        loadData();
        setInterval(loadData, 300000);
    </script>
</body>
</html>
