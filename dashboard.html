<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Tracker Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; font-weight: 600; }
        .update-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .update-btn:hover { background: #2563eb; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; }
        .stat-card h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; }
        .stat-card .value.positive { color: #22c55e; }
        .stat-card .value.negative { color: #ef4444; }
        .stat-card .sub { font-size: 13px; color: #64748b; margin-top: 4px; }

        .chart-section { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 30px; }
        .chart-section h2 { font-size: 18px; margin-bottom: 15px; }

        .trades-section { background: #1e293b; border-radius: 12px; padding: 20px; }
        .trades-section h2 { font-size: 18px; margin-bottom: 15px; }
        .trades-table { width: 100%; border-collapse: collapse; }
        .trades-table th { text-align: left; padding: 12px; border-bottom: 1px solid #334155; color: #94a3b8; font-size: 12px; }
        .trades-table td { padding: 12px; border-bottom: 1px solid #334155; font-size: 14px; }
        .trades-table tr:hover { background: #334155; }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .last-updated { text-align: center; color: #64748b; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Trading Tracker</h1>
            <button class="update-btn" onclick="updateData()">Update Data</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Today P&L</h3>
                <div class="value" id="today-pl">$0.00</div>
                <div class="sub" id="today-orders">0 orders</div>
            </div>
            <div class="stat-card">
                <h3>Today Win Rate</h3>
                <div class="value" id="today-winrate">0%</div>
            </div>
            <div class="stat-card">
                <h3>Month P&L</h3>
                <div class="value" id="month-pl">$0.00</div>
                <div class="sub" id="month-orders">0 orders</div>
            </div>
            <div class="stat-card">
                <h3>Month Win Rate</h3>
                <div class="value" id="month-winrate">0%</div>
            </div>
            <div class="stat-card">
                <h3>YTD P&L</h3>
                <div class="value" id="ytd-pl">$0.00</div>
                <div class="sub" id="ytd-orders">0 orders</div>
            </div>
            <div class="stat-card">
                <h3>YTD Win Rate</h3>
                <div class="value" id="ytd-winrate">0%</div>
            </div>
        </div>

        <div class="chart-section">
            <h2>Cumulative P&L (Year to Date)</h2>
            <canvas id="pnlChart" height="100"></canvas>
        </div>

        <div class="trades-section">
            <h2>Recent Trades (Last 7 Days)</h2>
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Type</th>
                        <th>Strike</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="trades-body">
                </tbody>
            </table>
        </div>

        <p class="last-updated">Last updated: <span id="last-updated">Never</span></p>
    </div>

    <script>
        let pnlChart = null;

        async function loadData() {
            const response = await fetch('/api/stats');
            const data = await response.json();

            // Update stats
            const pl = (val) => {
                const v = val || 0;
                return v >= 0 ? `+$${v.toFixed(2)}` : `-$${Math.abs(v).toFixed(2)}`;
            };
            const setPl = (id, val) => {
                const el = document.getElementById(id);
                el.textContent = pl(val);
                el.className = 'value ' + (val >= 0 ? 'positive' : 'negative');
            };

            setPl('today-pl', data.today.pl);
            setPl('month-pl', data.month.pl);
            setPl('ytd-pl', data.ytd.pl);

            document.getElementById('today-orders').textContent = `${data.today.orders} orders`;
            document.getElementById('today-winrate').textContent = `${data.today.win_rate}%`;
            document.getElementById('month-orders').textContent = `${data.month.orders} orders`;
            document.getElementById('month-winrate').textContent = `${data.month.win_rate}%`;
            document.getElementById('ytd-orders').textContent = `${data.ytd.orders} orders`;
            document.getElementById('ytd-winrate').textContent = `${data.ytd.win_rate}%`;
            document.getElementById('last-updated').textContent = new Date(data.last_updated).toLocaleString();

            // Update chart
            updateChart(data.ytd.daily_breakdown);

            // Load trades
            loadTrades();
        }

        function updateChart(dailyData) {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            const labels = dailyData.map(d => d.date);
            const data = dailyData.map(d => d.pl);

            // Calculate cumulative
            let cumulative = 0;
            const cumulativeData = data.map(v => { cumulative += v; return cumulative; });

            if (pnlChart) pnlChart.destroy();

            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: cumulativeData,
                        borderColor: cumulativeData[cumulativeData.length-1] >= 0 ? '#22c55e' : '#ef4444',
                        backgroundColor: cumulativeData[cumulativeData.length-1] >= 0 ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        async function loadTrades() {
            const response = await fetch('/api/trades?days=7');
            const trades = await response.json();

            const tbody = document.getElementById('trades-body');
            tbody.innerHTML = trades.map(t => `
                <tr>
                    <td>${new Date(t.timestamp).toLocaleDateString()}</td>
                    <td>${t.symbol}</td>
                    <td>${t.side}</td>
                    <td>${t.quantity}</td>
                    <td>$${t.price.toFixed(2)}</td>
                    <td>${t.type}</td>
                    <td>${t.strike || 'N/A'}</td>
                    <td class="${t.realized_pl >= 0 ? 'positive' : 'negative'}">
                        ${t.realized_pl >= 0 ? '+' : ''}$${(t.realized_pl || 0).toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }

        async function updateData() {
            const btn = document.querySelector('.update-btn');
            btn.textContent = 'Updating...';
            await fetch('/api/update');
            await loadData();
            btn.textContent = 'Update Data';
        }

        // Auto-refresh every 5 minutes
        loadData();
        setInterval(loadData, 300000);
    </script>
</body>
</html>
